<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root {
    --bg: #0f1220;
    --fg: #e7e9ee;
    --muted: #9aa4b2;
    --accent: #6366f1;
    --accent-600: #5458ee;
    --accent-700: #4b50e6;
    --card-bg: #171a2b;
    --card-elev: #1c2034;
    --border: #2a2e4a;
    --danger: #ef4444;
    --success: #22c55e;
    --warning: #f59e0b;
    --shadow: 0 8px 24px rgba(0,0,0,0.35);
    --radius: 14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: auto 1fr;
    grid-template-areas:
      "sidebar header"
      "sidebar main";
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
    background: radial-gradient(1200px 600px at 10% -10%, #1a1f35 10%, transparent 60%) no-repeat, var(--bg);
    color: var(--fg);
    overflow: hidden;
  }

  /* Sidebar */
  #sidebar {
    grid-area: sidebar;
    background: linear-gradient(180deg, #151831 0%, #121524 100%);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    height: 100vh;
    position: sticky;
    top: 0;
  }
  #brand {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 16px;
    border-bottom: 1px solid var(--border);
  }
  #brand .logo {
    width: 36px; height: 36px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), #22d3ee);
    box-shadow: var(--shadow);
  }
  #brand h1 {
    font-size: 1.05rem;
    letter-spacing: 0.3px;
  }
  #nav {
    padding: 10px;
    display: grid;
    gap: 6px;
  }
  #nav button {
    background: transparent;
    border: 1px solid transparent;
    color: var(--fg);
    padding: 10px 12px;
    text-align: left;
    cursor: pointer;
    font-size: 0.95rem;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background .2s, border-color .2s, transform .02s;
  }
  #nav button:hover { background: #1a1e35; border-color: #252a45; }
  #nav button:active { transform: translateY(1px); }
  #nav button.active {
    background: #1f2442;
    border-color: #2b2f54;
    outline: 2px solid rgba(99,102,241,.35);
  }
  .nav-emoji { width: 20px; text-align: center; }

  /* Header */
  #app-header {
    grid-area: header;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(24,27,45,.7), rgba(24,27,45,.35));
    backdrop-filter: blur(6px);
    position: sticky;
    top: 0;
    z-index: 3;
  }
  #app-header .controls {
    display: flex; align-items: center; gap: 10px;
  }
  .pill {
    background: #1b1f36;
    border: 1px solid var(--border);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: .85rem;
    color: var(--muted);
  }
  .switch {
    display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
  }
  .switch input { display: none; }
  .switch .track {
    width: 42px; height: 22px; background: #2b3052; border-radius: 999px; position: relative;
    transition: background .2s;
    border: 1px solid #3a3f66;
  }
  .switch .thumb {
    position: absolute; top: 50%; left: 3px; transform: translateY(-50%);
    width: 16px; height: 16px; border-radius: 50%; background: #fff; transition: left .2s;
  }
  .switch input:checked + .track { background: var(--accent); }
  .switch input:checked + .track .thumb { left: 23px; }

  /* Main now uses flex so the chat can expand */
  #main {
    grid-area: main;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 54px);
    overflow: hidden;
    min-height: 0;
  }

  /* Section Titles */
  .section {
    padding: 14px 16px;
    display: none;
  }
  .section.active { display: block; }
  .section h2 {
    font-size: 1.1rem;
    margin-bottom: 12px;
    color: var(--fg);
  }

  /* Cards & Lists */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 12px;
  }
  ul { list-style: none; }
  .list { display: grid; gap: 10px; }
  .item {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
    background: var(--card-elev);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
  }
  .meta { display: flex; flex-direction: column; gap: 4px; }
  .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .badge {
    padding: 2px 8px; border-radius: 999px; font-size: .75rem; font-weight: 600;
    border: 1px solid #334;
  }
  .badge.active { background: rgba(34,197,94,.15); color: #86efac; border-color: #2f6; }
  .badge.expired { background: rgba(239,68,68,.15); color: #fecaca; border-color: #f66; }
  .txid { font-size: .84rem; color: var(--muted); }
  .copy {
    background: #262b49; border: 1px solid #39406b; color: var(--fg);
    padding: 6px 10px; border-radius: 10px; cursor: pointer; font-size: .9rem;
  }
  .copy:hover { background: #2d3358; }
  .btn {
    background: var(--accent); color: #fff; border: none;
    padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: .92rem;
    box-shadow: 0 6px 18px rgba(99,102,241,.25);
    transition: background .15s, transform .02s;
  }
  .btn:hover { background: var(--accent-600); }
  .btn:active { transform: translateY(1px); }
  .btn.secondary { background: #2a2f52; }
  .btn.success { background: var(--success); }
  .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; }
  .toolbar .right { display: flex; gap: 8px; }

  /* Conversation header */
  #conv-header {
    display: none;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, #171a2b, #14172a);
  }
  #conv-header .left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  #conv-header .id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  #backBtn { background:#222845; border:1px solid #2e3560; }

  /* Tabs */
  #tabs {
    display: none;
    border-bottom: 1px solid var(--border);
    background: #14172a;
    padding: 6px 8px;
    gap: 6px;
  }
  #tabs button {
    background: #1a1f38; border: 1px solid #2a3158; color: var(--fg);
    padding: 8px 10px; border-radius: 999px; cursor: pointer; font-size: .9rem;
  }
  #tabs button.active { background: var(--accent); border-color: var(--accent-700); }

  /* Messages -> flex:1 so it fills height */
  #messages {
    display: none;
    overflow-y: auto;
    padding: 16px;
    background: radial-gradient(900px 480px at 80% -20%, rgba(99,102,241,.12), transparent 60%) no-repeat, var(--bg);
    position: relative;
    flex: 1;
    min-height: 0; /* make flexbox allow scrolling area */
  }
  .msg {
    margin-bottom: 12px;
    max-width: min(680px, 80%);
    padding: 10px 12px;
    border-radius: 14px;
    line-height: 1.45;
    border: 1px solid var(--border);
    background: var(--card-elev);
    box-shadow: var(--shadow);
    word-wrap: break-word;
    overflow-wrap: anywhere;
  }
  .msg.user { margin-left: auto; background: #1d2240; border-color: #2d3566; }
  .msg.admin { background: #1b233d; border-color: #2a335b; }
  .msg .time { display: block; margin-top: 6px; font-size: .78rem; color: var(--muted); }
  .msg img { display: block; margin-top: 8px; max-width: 100%; height: auto; border-radius: 10px; border: 1px solid #2a3158; }

  /* Reply Box */
  #reply-box {
    display: none;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    background: linear-gradient(180deg, #151a2e, #121524);
    gap: 10px;
  }
  #replyText {
    width: 100%;
    min-height: 140px;
    max-height: 40vh;
    background: #0f1329;
    border: 1px solid #273056;
    border-radius: 12px;
    color: var(--fg);
    padding: 10px 12px;
    resize: vertical;
    font-family: inherit;
    font-size: .95rem;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
  }
  .actions {
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .checkbox { display: inline-flex; align-items: center; gap: 8px; font-size: .9rem; color: var(--muted); }

  /* Scroll to bottom */
  #scroller {
    position: absolute; right: 16px; bottom: 16px;
    display: none;
  }

  /* Empty state */
  .empty {
    padding: 18px;
    text-align: center;
    color: var(--muted);
    border: 1px dashed var(--border);
    border-radius: 12px;
    background: #151936;
  }

  /* Toasts */
  #toast {
    position: fixed;
    right: 16px; bottom: 16px;
    display: grid; gap: 8px;
    z-index: 50;
  }
  .toast {
    background: #1f243f; border: 1px solid #334; color: var(--fg);
    padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow);
    font-size: .92rem;
  }

  /* Hide list sections when chat is open */
  body.chat-open .section { display: none !important; }
  body.chat-open #conv-header,
  body.chat-open #tabs,
  body.chat-open #messages,
  body.chat-open #reply-box { display: flex; }
  body.chat-open #messages { display: block; }

  /* Responsive */
  @media (max-width: 960px) {
    body { grid-template-columns: 1fr; grid-template-areas:
      "header"
      "main"; }
    #sidebar { display: none; }
    #app-header { position: sticky; top: 0; }
  }
</style>
</head>
<body>

<aside id="sidebar">
  <div id="brand">
    <div class="logo"></div>
    <h1>Admin Panel</h1>
  </div>
  <nav id="nav">
    <button class="active" data-section="conversations"><span class="nav-emoji">üí¨</span>Conversations</button>
    <button data-section="pending"><span class="nav-emoji">üí≥</span>Pending Payments</button>
    <button data-section="completed"><span class="nav-emoji">‚úÖ</span>Completed Payments</button>
  </nav>
</aside>

<header id="app-header">
  <div class="pill">Server: <span class="mono" id="serverHost">‚Äî</span></div>
  <div class="controls">
    <label class="switch">
      <input type="checkbox" id="autoRefresh">
      <span class="track"><span class="thumb"></span></span>
    </label>
    <span class="muted">Auto Refresh</span>
    <button class="btn secondary" id="refreshBtn" title="Refresh current section">Refresh</button>
  </div>
</header>

<main id="main">
  <!-- Conversations Section -->
  <section id="section-conversations" class="section active">
    <div class="toolbar">
      <h2>All Users with Conversations</h2>
      <div class="right">
        <button class="btn secondary" id="reloadUsers">Reload</button>
      </div>
    </div>
    <div class="card">
      <ul id="usersList" class="list"></ul>
      <div id="usersEmpty" class="empty hidden">No users found yet.</div>
    </div>
  </section>

  <!-- Pending Payments Section -->
  <section id="section-pending" class="section">
    <div class="toolbar">
      <h2>Pending Payments</h2>
      <div class="right">
        <button class="btn secondary" id="reloadPending">Reload</button>
      </div>
    </div>
    <div class="card">
      <ul id="pendingList" class="list"></ul>
      <div id="pendingEmpty" class="empty hidden">No pending payments.</div>
    </div>
  </section>

  <!-- Completed Payments Section -->
  <section id="section-completed" class="section">
    <div class="toolbar">
      <h2>Completed Payments</h2>
      <div class="right">
        <button class="btn secondary" id="reloadCompleted">Reload</button>
      </div>
    </div>
    <div class="card">
      <ul id="completedList" class="list"></ul>
      <div id="completedEmpty" class="empty hidden">No completed payments yet.</div>
    </div>
  </section>

  <!-- Chat UI -->
  <div id="conv-header" class="card">
    <div class="left">
      <button class="btn secondary" id="backBtn">Back</button>
      <strong>User:</strong> <span class="id mono" id="convUser"></span>
      <button class="copy" id="copyUser">Copy</button>
    </div>
    <div class="row">
      <strong>Plan:</strong> <span id="convPlan"></span>
    </div>
  </div>

  <div id="tabs" class="row" style="padding:8px 16px;">
    <button data-topic="trade_setup" class="active">üìâ Trade Setup Review</button>
    <button data-topic="emergency_support">üö® Emergency Support</button>
  </div>

  <div id="messages"></div>

  <div id="reply-box">
    <textarea id="replyText" placeholder="Type your reply‚Ä¶"></textarea>
    <div class="actions">
      <label class="checkbox"><input type="checkbox" id="markFinal"/> Mark Final</label>
      <div class="row">
        <button class="btn secondary" id="draftBtn">Generate AI Draft</button>
        <button class="btn" id="sendBtn">Send Reply</button>
      </div>
    </div>
  </div>

  <button id="scroller" class="btn secondary">Scroll to latest</button>
</main>

<div id="toast"></div>

<script>
  // ====== CONFIG (unchanged as requested) ======
  const API_BASE = "https://server-production-dd28.up.railway.app";
  const ADMIN_SECRET = "123456"; // keep as-is

  // ====== STATE ======
  let currentSection = "conversations";
  let currentUser = null;
  let currentPlan = null;
  let currentTopic = "trade_setup";
  let autoRefreshTimer = null;
  let loading = false;

  // ====== HELPERS ======
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function toast(msg, type="info") {
    const el = document.createElement("div");
    el.className = "toast";
    el.textContent = msg;
    if (type === "error") el.style.borderColor = "#f66";
    if (type === "success") el.style.borderColor = "#2f6";
    $("#toast").append(el);
    setTimeout(() => el.remove(), 3000);
  }

  function setServerHost() {
    try {
      const u = new URL(API_BASE);
      $("#serverHost").textContent = u.host;
    } catch (e) {
      $("#serverHost").textContent = API_BASE;
    }
  }

  function setLoading(v) {
    loading = v;
    $("#refreshBtn").disabled = v;
    $("#reloadUsers")?.setAttribute("disabled", v);
    $("#reloadPending")?.setAttribute("disabled", v);
    $("#reloadCompleted")?.setAttribute("disabled", v);
    $("#draftBtn").disabled = v;
    $("#sendBtn").disabled = v;
  }

  function formatTime(iso) {
    try {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleString();
    } catch {
      return "";
    }
  }

  function copyText(text) {
    navigator.clipboard.writeText(text).then(() => toast("Copied to clipboard", "success"))
      .catch(() => toast("Copy failed", "error"));
  }

  function formatPackageExpiry(user) {
    if (user.package !== "Elite") return null;
    
    // If no package_start date, show a default countdown for existing Elite users
    if (!user.package_start) {
      return { text: "30 days left", color: "#22c55e", urgent: false };
    }
    
    const startDate = new Date(user.package_start);
    const expiryDate = new Date(startDate.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days
    const now = new Date();
    const daysLeft = Math.ceil((expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));
    
    if (daysLeft <= 0) {
      return { text: "Expired", color: "#ef4444", urgent: true };
    } else if (daysLeft <= 3) {
      return { text: `${daysLeft} days left`, color: "#f59e0b", urgent: true };
    } else if (daysLeft <= 7) {
      return { text: `${daysLeft} days left`, color: "#f59e0b", urgent: false };
    } else {
      return { text: `${daysLeft} days left`, color: "#22c55e", urgent: false };
    }
  }

  function showSection(name) {
    currentSection = name;
    $$(".section").forEach(s => s.classList.remove("active"));
    $(`#section-${name}`).classList.add("active");
    $$("#nav button").forEach(b => b.classList.toggle("active", b.dataset.section === name));
    // Leaving chat view if switching sections
    if (document.body.classList.contains('chat-open')) exitChat();
  }

  function toggleChatUI(show) {
    document.body.classList.toggle('chat-open', show);
    $("#conv-header").style.display = show ? "flex" : "none";
    $("#tabs").style.display = show ? "flex" : "none";
    $("#messages").style.display = show ? "block" : "none";
    $("#reply-box").style.display = show ? "block" : "none";
  }

  function controlScroller() {
    const nearBottom = $("#messages").scrollHeight - $("#messages").scrollTop - $("#messages").clientHeight < 120;
    $("#scroller").style.display = nearBottom ? "none" : "block";
  }

  function autoScroll() {
    $("#messages").scrollTop = $("#messages").scrollHeight;
  }

  async function safeFetch(url, options={}) {
    const defaultHeaders = { "x-admin-secret": ADMIN_SECRET };
    options.headers = Object.assign({}, defaultHeaders, options.headers || {});
    let res;
    try {
      setLoading(true);
      res = await fetch(url, options);
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || ("HTTP "+res.status));
      }
      return res;
    } catch (e) {
      console.error(e);
      toast("Request failed: " + e.message, "error");
      throw e;
    } finally {
      setLoading(false);
    }
  }

  // ====== LOADERS ======
  async function loadUsers() {
    const ul = $("#usersList");
    if (!ul) return;
    ul.innerHTML = "";
    $("#usersEmpty")?.classList.add("hidden");

    try {
      const res = await safeFetch(`${API_BASE}/api/admin/users-with-conversations`);
      const data = await res.json();
      if (!data || !data.length) {
        $("#usersEmpty")?.classList.remove("hidden");
        return;
      }
      data.forEach(u => {
        const li = document.createElement("li");
        li.className = "item";
        const badgeClass = (u.status || "").toLowerCase() === "active" ? "badge active" : "badge expired";
        const expiryInfo = formatPackageExpiry(u);
        
        li.innerHTML = `
          <div class="meta">
            <div class="row">
              <span class="mono">${u.id}</span>
              <button class="copy" data-copy="${u.id}">Copy</button>
            </div>
            <div class="row">
              <span class="${badgeClass}">${u.package ?? "‚Äî"} ‚Ä¢ ${u.status ?? "‚Äî"}</span>
              ${expiryInfo ? `<span style="color: ${expiryInfo.color}; font-weight: 600; margin-left: 8px;">${expiryInfo.urgent ? "‚ö†Ô∏è " : ""}${expiryInfo.text}</span>` : ""}
            </div>
          </div>
          <div class="row">
            <button class="btn" data-open="${u.id}" data-plan="${u.package ?? ""}">Open Chat</button>
            <button class="btn danger" data-delete="${u.id}">Delete User</button>
          </div>
        `;
        ul.append(li);
      });
    } catch { /* handled in safeFetch */ }
  }

  async function loadPending() {
    const ul = $("#pendingList");
    if (!ul) return;
    ul.innerHTML = "";
    $("#pendingEmpty")?.classList.add("hidden");

    try {
      const res = await safeFetch(`${API_BASE}/api/admin/pending-payments`);
      const data = await res.json();
      if (!data || !data.length) {
        $("#pendingEmpty")?.classList.remove("hidden");
        return;
      }
      data.forEach(p => {
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="meta">
            <div class="row">
              <strong class="mono">${p.user_id}</strong> ‚Üí <span>${p.package}</span>
            </div>
            <div class="txid">TXID: <span class="mono">${p.txid}</span> ‚Ä¢ ${formatTime(p.created_at)}</div>
          </div>
          <div class="row">
            <button class="copy" data-copy="${p.txid}">Copy TXID</button>
            <button class="btn secondary" data-open="${p.user_id}" data-plan="${p.package}">Open Chat</button>
            <button class="btn success" data-approve="${p.txid}">Approve</button>
          </div>
        `;
        ul.append(li);
      });
    } catch {}
  }

  async function loadCompleted() {
    const ul = $("#completedList");
    if (!ul) return;
    ul.innerHTML = "";
    $("#completedEmpty")?.classList.add("hidden");

    try {
      const res = await safeFetch(`${API_BASE}/api/admin/completed-payments`);
      const data = await res.json();
      if (!data || !data.length) {
        $("#completedEmpty")?.classList.remove("hidden");
        return;
      }
      data.forEach(p => {
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="meta">
            <div class="row">
              <strong class="mono">${p.user_id}</strong> ‚Üí <span>${p.package}</span>
            </div>
            <div class="txid">TXID: <span class="mono">${p.txid}</span> ‚Ä¢ Approved: ${formatTime(p.verified_at)}</div>
          </div>
        `;
        ul.append(li);
      });
    } catch {}
  }

  async function approve(txid) {
    try {
      await safeFetch(`${API_BASE}/api/admin/approve-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ txid, admin_notes: "Approved via dashboard" })
      });
      toast("Payment approved", "success");
      await loadPending();
      await loadCompleted();
    } catch {}
  }

  async function openChat(userId, plan) {
    currentUser = userId;
    currentPlan = plan;
    $("#convUser").textContent = userId;
    $("#convPlan").textContent = plan || "‚Äî";
    
    // Add expiry info to conversation header
    try {
      const res = await safeFetch(`${API_BASE}/api/admin/users-with-conversations`);
      const data = await res.json();
      const user = data.find(u => u.id === userId);
      if (user) {
        const expiryInfo = formatPackageExpiry(user);
        if (expiryInfo) {
          const expiryEl = document.createElement("div");
          expiryEl.style.cssText = `color: ${expiryInfo.color}; font-weight: 600; font-size: 12px; margin-top: 4px;`;
          expiryEl.textContent = `${expiryInfo.urgent ? "‚ö†Ô∏è " : ""}${expiryInfo.text}`;
          $("#convPlan").parentNode.appendChild(expiryEl);
        }
      }
    } catch (e) {
      console.warn("Failed to load user expiry info:", e);
    }
    
    toggleChatUI(true);
    await loadConversation();
    autoScroll();
  }

  function exitChat() {
    currentUser = null;
    currentPlan = null;
    toggleChatUI(false);
    // Return to conversations list
    showSection('conversations');
  }

  async function loadConversation() {
    if (!currentUser) return;
    const url = `${API_BASE}/api/admin/conversation?userId=${encodeURIComponent(currentUser)}&topic=${encodeURIComponent(currentTopic)}`;
    const container = $("#messages");
    container.innerHTML = "";
    try {
      const res = await safeFetch(url);
      const data = await res.json();
      const messages = data?.messages || [];
      if (!messages.length) {
        container.innerHTML = `<div class="empty">No messages in this topic yet.</div>`;
      } else {
        messages.forEach(m => {
          const div = document.createElement("div");
          div.className = "msg " + (m.role || "user");
          if (m.content && m.content.trim() !== "") {
            const textEl = document.createElement("div");
            textEl.textContent = m.content;
            div.appendChild(textEl);
          }
          if (m.image_url) {
            const img = document.createElement("img");
            img.src = m.image_url;
            img.alt = "Attachment";
            div.appendChild(img);
          }
          const t = document.createElement("span");
          t.className = "time";
          t.textContent = formatTime(m.created_at) || "";
          div.appendChild(t);
          container.append(div);
        });
      }
      controlScroller();
    } catch {}
  }

  async function generateAIDraft() {
    if (!currentUser) return toast("Open a chat first");
    try {
      const res = await safeFetch(`${API_BASE}/api/admin/generate-ai-draft`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: currentUser, topic: currentTopic })
      });
      const data = await res.json();
      $("#replyText").value = data?.draft || "";
      if (!data?.draft) toast("No draft returned");
    } catch {}
  }

  async function sendReply() {
    if (!currentUser) return toast("Open a chat first");
    const reply = $("#replyText").value.trim();
    const markFinal = $("#markFinal").checked;
    if (!reply) return toast("Reply cannot be empty", "error");
    try {
      await safeFetch(`${API_BASE}/api/admin/respond`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: currentUser, topic: currentTopic, reply, markFinal })
      });
      $("#replyText").value = "";
      await loadConversation();
      autoScroll();
      toast("Reply sent", "success");
    } catch {}
  }

  async function deleteUser(userId) {
    if (!userId) return;
    if (!confirm(`Delete user ${userId}? This cannot be undone.`)) return;
    try {
      await safeFetch(`${API_BASE}/api/admin/delete-user`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
      });
      toast("User deleted", "success");
      // Refresh lists
      await loadUsers();
      await loadPending();
      await loadCompleted();
      // Exit chat if we deleted the currently open user
      if (currentUser === userId) exitChat();
    } catch {}
  }

  // ====== EVENT BINDINGS ======
  $$("#nav button").forEach(btn => {
    btn.addEventListener("click", () => showSection(btn.dataset.section));
  });

  // Toolbar buttons
  $("#reloadUsers").addEventListener("click", loadUsers);
  $("#reloadPending").addEventListener("click", loadPending);
  $("#reloadCompleted").addEventListener("click", loadCompleted);
  $("#refreshBtn").addEventListener("click", () => {
    if (currentSection === "conversations") return loadUsers();
    if (currentSection === "pending") return loadPending();
    if (currentSection === "completed") return loadCompleted();
  });

  // Copy user id
  $("#copyUser").addEventListener("click", () => currentUser && copyText(currentUser));

  // Back button
  $("#backBtn").addEventListener("click", exitChat);

  // Lists: delegate clicks (copy/open/approve)
  document.addEventListener("click", (e) => {
    const t = e.target;
    if (t.matches("[data-copy]")) copyText(t.getAttribute("data-copy"));
    if (t.matches("[data-open]")) {
      const userId = t.getAttribute("data-open");
      const plan = t.getAttribute("data-plan") || "";
      openChat(userId, plan);
    }
    if (t.matches("[data-approve]")) {
      const txid = t.getAttribute("data-approve");
      approve(txid);
    }
    if (t.matches("[data-delete]")) {
      const userId = t.getAttribute("data-delete");
      deleteUser(userId);
    }
  });

  // Tabs
  $$("#tabs button").forEach(btn => {
    btn.addEventListener("click", () => {
      $$("#tabs button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentTopic = btn.dataset.topic;
      loadConversation().then(autoScroll);
    });
  });

  // Chat controls
  $("#draftBtn").addEventListener("click", generateAIDraft);
  $("#sendBtn").addEventListener("click", sendReply);
  $("#messages").addEventListener("scroll", controlScroller);
  $("#scroller").addEventListener("click", autoScroll);

  // Auto refresh
  $("#autoRefresh").addEventListener("change", (e) => {
    if (e.target.checked) {
      autoRefreshTimer = setInterval(() => {
        if (currentSection === "conversations") loadUsers();
        if (currentSection === "pending") loadPending();
        if (currentSection === "completed") loadCompleted();
        if (currentUser) loadConversation();
      }, 30000);
      toast("Auto refresh on");
    } else {
      clearInterval(autoRefreshTimer);
      autoRefreshTimer = null;
      toast("Auto refresh off");
    }
  });

  // INIT
  setServerHost();
  loadUsers();
  loadPending();
  loadCompleted();
</script>
</body>
</html>
